- name: Github Init Playbook
  gather_facts: no
  hosts: localhost
  vars:
    source_key: "ssh/id_rsa"
    dest_key: "{{ lookup('env', 'HOME') }}/.ssh/id_rsa"

  tasks:
    - name: 1/6] git user.email
      git_config:
        name: user.email
        scope: global
        value: "curelesss@gmail.com"
      tags: github

    - name: 2/6] git user.name
      git_config:
        name: user.name
        scope: global
        value: "curelesss"
      tags: github

    - name: 3/6] Ensure .ssh directory exists
      file:
        dest: "{{ dest_key | dirname }}"
        mode: 0700
        state: directory
      tags: github

    - name: 4/6] Install ssh key
      copy:
        src: "{{ source_key }}"
        dest: "{{ dest_key }}"
        mode: 0600
      tags: github

    - name: 5/6] Install git config
      ansible.builtin.copy:
        src: ssh/config
        dest: "{{ lookup('env', 'HOME') }}/.ssh/config"
        mode: 0600
      tags: github

    - name: 6/6] Switch .ini repo from HTTPS to SSH
      community.general.git_config:
        name: remote.origin.url
        value: "git@github.com:curelesss/.ini.git"
        scope: local
        repo: "{{ ansible_env.HOME }}/.ini"
      # This ensures the task only runs if the directory actually exists
      when: (ansible_env.HOME + '/.ini') is directory
