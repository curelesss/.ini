- name: Github Init Playbook
  gather_facts: no
  hosts: localhost
  vars:
    source_key: "ssh/id_rsa"
    dest_key: "{{ lookup('env', 'HOME') }}/.ssh/id_rsa"

  tasks:
    - name: 1/6] git user.email
      git_config:
        name: user.email
        scope: global
        value: "curelesss@gmail.com"
      tags: github

    - name: 2/6] git user.name
      git_config:
        name: user.name
        scope: global
        value: "curelesss"
      tags: github

    - name: 3/6] Ensure .ssh directory exists
      file:
        dest: "{{ dest_key | dirname }}"
        mode: 0700
        state: directory
      tags: github

    - name: 4/6] Install ssh key
      copy:
        src: "{{ source_key }}"
        dest: "{{ dest_key }}"
        mode: 0600
      tags: github

    - name: 5/6] Install git config
      ansible.builtin.copy:
        src: github/config
        dest: "{{ lookup('env', 'HOME') }}/.ssh/config"
        mode: 0600
      tags: github

    - name: 6/6] Ensure GitHub is in known_hosts (Standard and Port 443)
      ansible.builtin.known_hosts:
        name: "{{ item.name }}"
        key: "{{ item.key }}"
        state: present
      loop:
        - { name: "github.com", key: "{{ lookup('pipe', 'ssh-keyscan -t ed25519 github.com') }}" }
        - { name: "[ssh.github.com]:443", key: "{{ lookup('pipe', 'ssh-keyscan -p 443 -t ed25519 ssh.github.com') }}" }
      tags: github
